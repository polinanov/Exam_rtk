# Двуфакторная авторизация

**Акторы:** пользователь, фронтент, бекенд, БД.

**Цель:** пользователь авторизуется на сайте, чтобы получить доступ к недоступным неавторизированным пользователям разделам.

**Предусловия:** у пользователя открыта страница сайта двухфакторной авторизации.

**Сценарий:**
1. Пользователь вводит данные в поля формы авторизации (поле логин, пароль и номер телефона) и отправляет заполненную форму.
2. Фронтент посылает POST-запрос с пользовательскими данными и отображает пользователю поле ввода  СМС-кода и кнопку повторной отправки  СМС-кода.

Пользователь хочет [повторно отослать код](#Повторная_отправка_кода).  

3. Бекенд посылает запрос на получение данных из БД (пользовательские данные).
4. БД возвращает ответ "пользовательские данные найдены".  

БД возвращает ответ ["пользователь не нейден"](#Пользователь_не_найден).  
БД возвращает ответ ["неверный пароль"](#Неверный_пароль).

5. Бекенд генерирует код для подтверждения личности пользователя.
6. Бекенд посылает запрос на запись/изменение в БД сгенерированного кода.  
7. БД возвращает ответ "данные обновлены".
8. Бекенд отправляет сгенерированный код на SMSC.
9. SMSC, используя SMS-шлюз, передает сгенерированный код по протоколу SMPP в SMSC мобильного оператора.
10. SMSC мобильного оператора отправляет пользователю мобильное устройство сгенерированный код.  
11. Пользователь получил код СМС-сообщением (на телефон, который он указывал при регистрации).  

Пользователь не получил код, [повторно отослать код](#Повторная_отправка_кода).  

12. Пользователь вводит код из СМС-сообщения в форму.
13. Фронтент посылает POST-запрос с введенным кодом.
14. Бекенд посылает запрос на получение данных из БД (пользовательские данные + код).
15. БД возвращает ответ "код правильный".  

БД возвращает ответ ["код не правильный"](#Код_не_правильный).  

16. Бекенд начинает веб-сессию для пользователя.
17. Фронтен отображает пользователю нужные разделы.

**Результат:**
* Пользователь успешно получил доступ к недоступным разделам.



**Альтернативный сценарий:**

2а. <a name="Повторная_отправка_кода"></a> *Повторная отправка кода*.  
Возврат на шаг 1.  

4а. <a name="Пользователь_не_найден"></a> *Пользователь не найден*.  
4а1. Фронтент отображает пользователю "Пользователь не зарегистрирован" и перенаправляет на страницу регистрации.  

4б. <a name="Неверный_пароль"></a> *Неверный пароль*.  
4б1. Фронтент отображает пользователю "Неверный пароль".  
Возврат на шаг 1.  

15а. <a name="Код_не_правильный"></a> *Код не правильный*.  
15а1. Фронтент отображает пользователю "Код не правильный".  
Возврат на шаг 1.  

# Диаграмма sequence
![sequence](http://www.plantuml.com/plantuml/svg/ZLB1QXin4BthAmQVsaFetOSIbCr2AAv3tD2Za5UJibYHjYDjIlw-ci7QohLhQZ0xE-_DwEtJkqtPKfvVlR93ZWJF2KdjunoSfNTOzHH3nk1MO1FqQYXl53siD0w7sjRAsMptDY6ikbBfKWdGwJBWFGvvZ271QhVPtHbjmq5GBYxWcwsWcwrIFiO9CiseM1NSV8P-3VtelNaPqRlquIEB7jziHkX1zN1JA7eDZzlTD_E4FsTCkULeK9gtT8LpX0rBDvrkQ2oxqx9BU6agub28XUMmvLcVOMPj8MPuOTSKy4_6MUtNc8tqowWW8b9SNaCtfidRTtDF5AaGq2U4oQRqAvA3CGoH28SX_xNpySWm3mlZlxVpLu080fbWuGZn3Oa_zYuwD3ym85c-ahfrCUqX94BAdvwdiWVDKEYLqxeYZJyMKhLm-wMoJrrS3f5Ch667mPcxIyiPbvPKFB7PNk0xl31HMsL46kMvk7LzHnreKdWVCj89luVpy5NiB7LTJTrryzhyySWL-pY9V1-cnkQOcjFeiE0bDekywz6fBCcF775-m9xG7lu1diSClkFUx32b9cFdMfzmQX9pLMUXdl0mEBKKzT-OrhSlMjqMU7xrlm40 "Диаграмма sequence")

